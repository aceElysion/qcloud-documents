
**如需使用下载到本地的物理备份文件在其他主机上恢复数据库，可参考此文档**
### 下载备份文件
具体步骤请参考：[具体的下载说明](https://cloud.tencent.com/document/product/236/7358)

### 解包备份文件
由于备份文件先经过qpress压缩，后经过xbstream打包(xbstream为Percona的一种打包/解包工具)，所以下载备份文件后，应该先用xbstream将其解包。xbstream工具可以通过添加Percona的yum源安装或者直接下载二进制包。
- 通过Percona yum源安装
```
yum install http://www.percona.com/downloads/percona-release/redhat/0.1-3/percona-release-0.1-3.noarch.rpm
yum install percona-xtrabackup-22
```
- 通过二进制包安装
访问[xtrabackup-download](https://www.percona.com/downloads/XtraBackup/LATEST/)页面，下载相应操作系统版本的xtrabackup二进制包

安装好xtrabackup之后，就可以用xbstream命令将备份文件解包到目标目录
```
xbstream -x -C /data < ~/test.xb
```
解包结果如下图所示：
[extract.png]

### 解压备份文件
备份文件经过quicklz算法压缩，要进行解压，需要使用qpress工具，qpress可通过访问[此处](http://www.quicklz.com/)来下载，下载之后通过以下命令解出qpress二进制文件。
```
tar -xf qpress-11-linux-x64.tar -C /usr/local/bin
source /etc/profile
```
使用qpress命令将目标目录下所有以`.qp`结尾的文件都解压出来
```
xtrabackup --decompress --target-dir=/data
```
**注：**xtrabackup默认在解压缩时不删除原始的压缩文件，若想解压完删除原始的压缩文件，可在上面的命令中加上`--remove-original`参数。
[decompress.png]

###  Prepare备份文件
备份解压出来之后，需要进行apply log操作，使用以下命令：
```
xtrabackup --prepare  --target-dir=/data
```
执行后如果结果中包含一下输出，则代表prepare成功。
[prepare.png]

### 配置文件修改
由于存在的版本问题，请将解压文件 backup-my.cnf 中的
innodb_checksum_algorithm、
innodb_log_checksum_algorithm、
innodb_fast_checksum、
innodb_page_size 、
innodb_log_block_size、
redo_log_version 注释掉，如下图：
![](https://mc.qcloudimg.com/static/img/10113311b33e398ce0df96ca419f7f45/3.png)

### 修改文件属主
修改文件属主，并检查文件所属为 mysql 用户：
```
chown -R mysql:mysql /data
```
![](https://mc.qcloudimg.com/static/img/efbdeb20e1b699295c6a4321943908b2/4.png)

### 启动 mysqld 进程并且登录验证
启动 mysqld 进程，并验证启动成功：
```
mysqld_safe --defaults-file=/data/backup-my.cnf --user=mysql --datadir=/data &
```
客户端登录 mysql 验证：
```
mysql  -uroot
```
![](https://mc.qcloudimg.com/static/img/346346626997b85385408ac728bf82ff/5.png)

> 注意：
* 恢复完成后，表 mysql.user 中是不包含 TencentDB 中创建的用户，需要新建。
* 新建用户前请执行如下 SQL：
```
delete from mysql.db where user<>'root' and char_length(user)>0;
delete from mysql.tables_priv where user<>'root' and char_length(user)>0;
flush privileges;
```





